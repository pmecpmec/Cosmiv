name: Dependabot Auto-merge

# Automatically merge Dependabot PRs that pass CI
# Only merges patch and minor updates (not major)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    name: Auto-merge Dependabot PRs
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Enable auto-merge for Dependabot PRs
        if: |
          github.event.pull_request.user.login == 'dependabot[bot]' &&
          (contains(github.event.pull_request.title, 'patch') || 
           contains(github.event.pull_request.title, 'minor') ||
           contains(github.event.pull_request.title, 'bump'))
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const title = context.payload.pull_request.title.toLowerCase();
            
            // Only auto-merge patch and minor updates
            if (title.includes('patch') || title.includes('minor') || title.includes('bump')) {
              try {
                await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                  merge_method: 'squash'
                });
                console.log(`✓ Auto-merged PR #${prNumber}`);
              } catch (error) {
                console.log(`⚠ Could not auto-merge PR #${prNumber}: ${error.message}`);
                // Try to enable auto-merge instead
                try {
                  await github.graphql(`
                    mutation enableAutoMerge($pullRequestId: ID!, $mergeMethod: PullRequestMergeMethod!) {
                      enablePullRequestAutoMerge(input: {
                        pullRequestId: $pullRequestId,
                        mergeMethod: $mergeMethod
                      }) {
                        pullRequest {
                          autoMergeRequest {
                            enabledAt
                          }
                        }
                      }
                    }
                  `, {
                    pullRequestId: context.payload.pull_request.node_id,
                    mergeMethod: 'SQUASH'
                  });
                  console.log(`✓ Enabled auto-merge for PR #${prNumber}`);
                } catch (graphqlError) {
                  console.log(`⚠ Could not enable auto-merge: ${graphqlError.message}`);
                }
              }
            } else {
              console.log(`⏭ Skipping PR #${prNumber} - not a patch/minor update`);
            }

